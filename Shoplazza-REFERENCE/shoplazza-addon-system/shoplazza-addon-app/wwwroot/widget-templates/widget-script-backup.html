(function() {
    'use strict';
    
    var WIDGET_CONFIG = {
        shop: '{{SHOP_DOMAIN}}',
        apiEndpoint: '{{API_ENDPOINT}}',
        debug: false
    };
    
    // Shoplazza-optimized storage with store-specific keys and expiration
    const shoplazzaStorage = {
        setAddon: (productId, data) => {
            const key = `sl_addon_${productId}_${window.location.hostname}`;
            sessionStorage.setItem(key, JSON.stringify({
                ...data,
                _shoplazza_store: window.location.hostname,
                _expires: Date.now() + 3600000 // 1 hour expiration
            }));
            console.log('Add-on selection backed up to sessionStorage:', data);
        },
        
        getAddon: (productId) => {
            const key = `sl_addon_${productId}_${window.location.hostname}`;
            const data = sessionStorage.getItem(key);
            if (data) {
                const parsed = JSON.parse(data);
                if (parsed._expires > Date.now()) {
                    return parsed;
                }
                sessionStorage.removeItem(key); // Clean expired data
                console.log('Expired add-on data cleaned:', key);
            }
            return null;
        },
        
        getAllAddons: () => {
            const addons = [];
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.startsWith(`sl_addon_`) && key.includes(window.location.hostname)) {
                    const data = sessionStorage.getItem(key);
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (parsed._expires > Date.now()) {
                            addons.push(parsed);
                        } else {
                            sessionStorage.removeItem(key); // Clean expired data
                        }
                    }
                }
            }
            return addons;
        },
        
        clearExpired: () => {
            const now = Date.now();
            let cleaned = 0;
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.startsWith(`sl_addon_`)) {
                    const data = sessionStorage.getItem(key);
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (parsed._expires && parsed._expires < now) {
                            sessionStorage.removeItem(key);
                            cleaned++;
                        }
                    }
                }
            }
            if (cleaned > 0) {
                console.log(`Cleaned ${cleaned} expired add-on entries`);
            }
            return cleaned;
        }
    };

    // Enhanced property compression for complex add-ons
    function compressAddonProperties(config) {
        const compressed = {
            _add_on_data: btoa(JSON.stringify(config)), // Base64 encoded full config
            _compressed: true,
            _v: 2 // Version flag for parsing
        };
        
        // Fallback display properties for checkout UI (within 50-property limit)
        if (config.title) compressed._add_on_title = config.title.slice(0, 50);
        if (config.price) compressed._add_on_price = config.price.toString();
        if (config.sku) compressed._add_on_sku = config.sku.slice(0, 20);
        
        return compressed;
    }

    // Store add-on selections with enhanced compression
    function backupAddOnSelections(productId, addOnConfig) {
        const backup = {
            productId: productId,
            variantId: addOnConfig.variantId,
            addOnConfig: addOnConfig,
            timestamp: Date.now(),
            properties: compressAddonProperties(addOnConfig)
        };
        
        shoplazzaStorage.setAddon(productId, backup);
    }

    // Shoplazza-specific fetch interception with property merging and rate limiting
    const originalFetch = window.fetch;
    let lastCartCall = 0;
    const CART_API_DELAY = 300; // ms - prevent API flooding

    window.fetch = async function(url, options) {
        if (typeof url === 'string' && url.includes('/api/cart')) {
            console.log('Intercepting Shoplazza cart API call:', url);
            
            // Rate limiting for cart API calls
            if (Date.now() - lastCartCall < CART_API_DELAY) {
                const delay = CART_API_DELAY - (Date.now() - lastCartCall);
                console.log(`Rate limiting: waiting ${delay}ms before cart API call`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            lastCartCall = Date.now();
            
            return interceptShoplazzaCartApiCall(url, options);
        }
        return originalFetch.apply(this, arguments);
    };

    // Intercept and modify Shoplazza cart API calls with property preservation
    async function interceptShoplazzaCartApiCall(url, options) {
        if (options && options.method === 'POST' && options.body) {
            try {
                const body = JSON.parse(options.body);
                
                // Merge existing properties for line items to prevent loss
                if (body.updates) {
                    const currentCart = await fetch('/api/cart', {
                        headers: getShoplazzaHeaders()
                    }).then(r => r.json());
                    
                    currentCart.items.forEach(item => {
                        if (item.properties) {
                            body.properties = body.properties || {};
                            body.properties[item.id] = {
                                ...item.properties,
                                ...(body.properties[item.id] || {})
                            };
                        }
                    });
                    
                    options.body = JSON.stringify(body);
                    console.log('Merged existing properties to prevent loss:', body.properties);
                }
                
                // Ensure add-on properties are included for new additions
                if (body.id && !body.properties) {
                    const addOnProperties = getCurrentAddOnProperties();
                    if (Object.keys(addOnProperties).length > 0) {
                        body.properties = addOnProperties;
                        options.body = JSON.stringify(body);
                        console.log('Added add-on properties to new cart item:', addOnProperties);
                    }
                }
            } catch (e) {
                console.warn('Could not parse Shoplazza cart API body:', e);
            }
        }
        
        return originalFetch(url, options);
    }

    // Get Shoplazza-specific headers including cart token
    function getShoplazzaHeaders() {
        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        // Include cart token if available
        const cartToken = getCartTokenFromCookie();
        if (cartToken) {
            headers['X-Shoplazza-Cart-Token'] = cartToken;
        }
        
        return headers;
    }

    // Extract cart token from cookies
    function getCartTokenFromCookie() {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'cart_token' || name === 'shoplazza_cart_token') {
                return value;
            }
        }
        return null;
    }

    // Enhanced error recovery for Shoplazza API calls
    function handleShoplazzaAPIError(error) {
        if (error.message && error.message.includes('Cart token mismatch')) {
            console.warn('Cart token mismatch detected, regenerating...');
            // Clear expired cart token
            document.cookie = 'cart_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
            document.cookie = 'shoplazza_cart_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
            
            // Regenerate cart by fetching current cart
            return fetch('/api/cart')
                .then(response => response.json())
                .then(() => {
                    console.log('Cart token regenerated successfully');
                    return true;
                })
                .catch(regenerateError => {
                    console.error('Failed to regenerate cart token:', regenerateError);
                    throw error; // Re-throw original error if regeneration fails
                });
        }
        
        // Handle other common Shoplazza API errors
        if (error.status === 429) {
            console.warn('Rate limit exceeded, implementing exponential backoff');
            return new Promise(resolve => {
                setTimeout(() => resolve(true), 2000); // Wait 2 seconds
            });
        }
        
        throw error; // Re-throw unhandled errors
    }

    // Get current add-on properties for injection into Shoplazza API calls
    function getCurrentAddOnProperties() {
        const properties = {};
        const selectedAddOns = getSelectedAddOns();
        
        selectedAddOns.forEach(addOn => {
            properties['_add_on_type'] = 'protection_plan';
            properties['_add_on_name'] = addOn.title;
            properties['_add_on_price'] = addOn.price.toString();
            properties['_add_on_sku'] = addOn.sku;
            properties['_add_on_description'] = addOn.description || '';
            properties['_compressed'] = true; // Flag for complex data
        });
        
        return properties;
    }

    // Get currently selected add-ons from the page
    function getSelectedAddOns() {
        const selectedAddOns = [];
        const checkboxes = document.querySelectorAll('.addon-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
            const addOnConfig = {
                title: checkbox.dataset.addonTitle,
                price: parseFloat(checkbox.dataset.addonPrice),
                sku: checkbox.dataset.addonSku,
                description: checkbox.dataset.addonDescription,
                variantId: checkbox.dataset.addonVariantId
            };
            selectedAddOns.push(addOnConfig);
        });
        
        return selectedAddOns;
    }

    // Monitor cart modifications and protect properties
    function setupCartModificationProtection() {
        // Watch for cart item removal
        const cartObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.removedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE && 
                            (node.classList.contains('cart-item') || 
                             node.classList.contains('cart__item') ||
                             node.hasAttribute('data-cart-item'))) {
                            console.log('Cart item removed, backing up properties');
                            backupRemovedItemProperties(node);
                        }
                    });
                }
            });
        });
        
        // Start observing cart container (try multiple Shoplazza selectors)
        const cartSelectors = [
            '.cart-container',
            '[data-cart-container]',
            '.cart__container',
            '.cart-items',
            '[data-cart-items]',
            '.cart-drawer',
            '[data-cart-drawer]'
        ];
        
        let cartContainer = null;
        for (const selector of cartSelectors) {
            cartContainer = document.querySelector(selector);
            if (cartContainer) break;
        }
        
        if (cartContainer) {
            cartObserver.observe(cartContainer, { childList: true, subtree: true });
            console.log('Cart modification protection enabled on:', cartContainer);
        } else {
            console.warn('Could not find cart container for modification protection');
        }
    }

    // Backup properties when items are removed
    function backupRemovedItemProperties(cartItem) {
        const productId = cartItem.dataset.productId;
        const properties = extractPropertiesFromCartItem(cartItem);
        
        if (properties && Object.keys(properties).length > 0) {
            const backup = {
                productId: productId,
                properties: properties,
                timestamp: Date.now(),
                _removed: true
            };
            shoplazzaStorage.setAddon(productId, backup);
            console.log('Backed up properties for removed item:', backup);
        }
    }

    // Extract properties from cart item DOM
    function extractPropertiesFromCartItem(cartItem) {
        const properties = {};
        const propertyInputs = cartItem.querySelectorAll('input[name^="properties["]');
        
        propertyInputs.forEach(input => {
            const name = input.name.match(/properties\[(.*?)\]/)?.[1];
            if (name) {
                properties[name] = input.value;
            }
        });
        
        return properties;
    }

    // Reapply add-on properties after cart modifications
    function reapplyAddOnProperties(cartItem, properties) {
        // Find or create property inputs with Shoplazza-specific naming
        Object.keys(properties).forEach(key => {
            let input = cartItem.querySelector(`input[name="properties[${key}]"]`);
            
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                input.name = `properties[${key}]`;
                input.value = properties[key];
                cartItem.appendChild(input);
            } else {
                input.value = properties[key];
            }
        });
        
        console.log('Reapplied add-on properties to cart item:', properties);
    }

    // Restore properties that may have been lost
    function restoreLostAddOnProperties() {
        const cartItems = document.querySelectorAll('[data-cart-item]');
        let restoredCount = 0;
        
        cartItems.forEach(item => {
            const productId = item.dataset.productId;
            const backup = shoplazzaStorage.getAddon(productId);
            
            if (backup && !hasAddOnProperties(item)) {
                console.log(`Restoring add-on properties for product ${productId}`);
                reapplyAddOnProperties(item, backup.properties);
                restoredCount++;
            }
        });
        
        window.__addonsRestored = restoredCount;
        if (restoredCount > 0) {
            console.log(`Restored ${restoredCount} add-on selections`);
        }
    }

    // Check if cart item has add-on properties
    function hasAddOnProperties(cartItem) {
        const propertyInputs = cartItem.querySelectorAll('input[name^="properties[_add_on_"]');
        return propertyInputs.length > 0;
    }

    // Backup current cart state when drawer closes
    function backupCurrentCartState() {
        const cartItems = document.querySelectorAll('[data-cart-item]');
        cartItems.forEach(item => {
            const productId = item.dataset.productId;
            const properties = extractPropertiesFromCartItem(item);
            if (properties && Object.keys(properties).length > 0) {
                const backup = {
                    productId: productId,
                    properties: properties,
                    timestamp: Date.now()
                };
                shoplazzaStorage.setAddon(productId, backup);
            }
        });
    }

    // Update add-on prices for currency changes
    function updateAddonPricesForCurrency(currency) {
        const addons = shoplazzaStorage.getAllAddons();
        addons.forEach(addon => {
            if (addon.addOnConfig && addon.addOnConfig.price) {
                // Convert price to new currency (simplified - in production, use proper conversion)
                const convertedPrice = convertPrice(addon.addOnConfig.price, currency);
                addon.addOnConfig.price = convertedPrice;
                shoplazzaStorage.setAddon(addon.productId, addon);
            }
        });
        
        // Update displayed prices on the page
        updateDisplayedAddonPrices(currency);
    }

    // Ensure add-ons persist to checkout with property compression and error recovery
    function validateCartBeforeCheckout() {
        return fetch('/api/cart', {
            headers: getShoplazzaHeaders()
        })
        .then(response => response.json())
        .then(cart => {
            const hasAddOn = cart.items.some(item => 
                item.properties && item.properties._add_on_type === 'protection_plan'
            );
            
            if (!hasAddOn) {
                console.log('Add-on missing from cart, attempting to restore...');
                const savedAddOns = shoplazzaStorage.getAllAddons();
                
                if (savedAddOns.length > 0) {
                    // Try to restore the first available add-on
                    const addOnToRestore = savedAddOns[0];
                    return restoreAddOnToCart(addOnToRestore);
                }
            }
            return Promise.resolve();
        })
        .catch(error => {
            console.error('Error validating cart before checkout:', error);
            return handleShoplazzaAPIError(error)
                .then(() => validateCartBeforeCheckout()) // Retry after error recovery
                .catch(recoveryError => {
                    console.error('Error recovery failed, proceeding to checkout anyway:', recoveryError);
                    return Promise.resolve(); // Continue to checkout even if validation fails
                });
        });
    }

    // Restore add-on to cart via Shoplazza API with proper headers and error handling
    function restoreAddOnToCart(addOnBackup) {
        return fetch('/api/cart/add', {
            method: 'POST',
            headers: getShoplazzaHeaders(),
            body: JSON.stringify({
                id: addOnBackup.variantId || addOnBackup.addOnConfig.variantId,
                quantity: 1,
                properties: addOnBackup.properties || addOnBackup.addOnConfig.properties
            })
        })
        .then(response => response.json())
        .then(cartData => {
            console.log('Add-on restored to cart before checkout:', cartData);
            return cartData;
        })
        .catch(error => {
            console.error('Failed to restore add-on to cart:', error);
            return handleShoplazzaAPIError(error)
                .then(() => restoreAddOnToCart(addOnBackup)) // Retry after error recovery
                .catch(recoveryError => {
                    console.error('Error recovery failed for add-on restoration:', recoveryError);
                    throw error; // Re-throw if recovery fails
                });
        });
    }

    // Handle both classic and one-page checkout flows with error recovery
    function setupCheckoutGuard() {
        // Handle checkout button clicks
        document.addEventListener('click', (e) => {
            const checkoutBtn = e.target.closest('[href*="/checkout"], [data-checkout]');
            if (checkoutBtn) {
                e.preventDefault();
                console.log('Checkout initiated, validating add-ons...');
                
                validateCartBeforeCheckout()
                    .then(() => {
                        console.log('Add-on validation complete, proceeding to checkout');
                        window.location.assign(checkoutBtn.href || '/checkout');
                    })
                    .catch(error => {
                        console.error('Add-on validation failed, proceeding to checkout anyway:', error);
                        window.location.assign(checkoutBtn.href || '/checkout');
                    });
            }
        });

        // Handle dynamic checkout buttons
        if (window.Shoplazza && window.Shoplazza.Checkout) {
            const originalInit = window.Shoplazza.Checkout.init;
            window.Shoplazza.Checkout.init = function(...args) {
                return validateCartBeforeCheckout()
                    .then(() => originalInit.apply(this, args))
                    .catch(error => {
                        console.error('Checkout validation failed, proceeding anyway:', error);
                        return originalInit.apply(this, args);
                    });
            };
        }
        
        // Handle quick checkout flows
        document.addEventListener('click', (e) => {
            const quickCheckoutBtn = e.target.closest('[data-quick-checkout], .quick-checkout');
            if (quickCheckoutBtn) {
                e.preventDefault();
                validateCartBeforeCheckout()
                    .then(() => {
                        // Trigger quick checkout
                        if (quickCheckoutBtn.dataset.quickCheckout) {
                            window.Shoplazza.QuickCheckout.init();
                        }
                    })
                    .catch(error => {
                        console.error('Quick checkout validation failed, proceeding anyway:', error);
                        if (quickCheckoutBtn.dataset.quickCheckout) {
                            window.Shoplazza.QuickCheckout.init();
                        }
                    });
            }
        });
    }

    // Track add-on system performance and success rates
    function setupAnalyticsTracking() {
        // Track property persistence success
        document.addEventListener('shoplazza:cart:updated', () => {
            if (window.Shoplazza && window.Shoplazza.analytics) {
                window.Shoplazza.analytics.track('Add-on Cart Properties Updated', {
                    count: shoplazzaStorage.getAllAddons().length,
                    restored: window.__addonsRestored || 0,
                    timestamp: Date.now(),
                    success: true
                });
            }
        });
        
        // Track checkout validation success
        const originalValidateCart = validateCartBeforeCheckout;
        validateCartBeforeCheckout = function() {
            const startTime = Date.now();
            return originalValidateCart.apply(this, arguments)
                .then(result => {
                    if (window.Shoplazza && window.Shoplazza.analytics) {
                        window.Shoplazza.analytics.track('Add-on Checkout Validation', {
                            success: true,
                            duration: Date.now() - startTime,
                            timestamp: Date.now()
                        });
                    }
                    return result;
                })
                .catch(error => {
                    if (window.Shoplazza && window.Shoplazza.analytics) {
                        window.Shoplazza.analytics.track('Add-on Checkout Validation', {
                            success: false,
                            error: error.message,
                            duration: Date.now() - startTime,
                            timestamp: Date.now()
                        });
                    }
                    throw error;
                });
        };
    }

    // Performance monitoring
    function setupPerformanceMonitoring() {
        // Monitor API call performance
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.includes('/api/cart')) {
                const startTime = performance.now();
                return originalFetch.apply(this, arguments)
                    .then(response => {
                        const duration = performance.now() - startTime;
                        if (duration > 1000) { // Log slow API calls
                            console.warn(`Slow cart API call: ${duration.toFixed(2)}ms to ${url}`);
                        }
                        return response;
                    });
            }
            return originalFetch.apply(this, arguments);
        };
    }

    // Test mobile PWA behavior
    function testMobilePWABehavior() {
        // Check if running in PWA mode
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                      window.navigator.standalone === true;
        
        if (isPWA) {
            console.log('Running in PWA mode, ensuring sessionStorage persistence');
            
            // Test sessionStorage persistence
            const testKey = 'pwa_test_key';
            sessionStorage.setItem(testKey, 'test_value');
            
            // Verify persistence after a short delay
            setTimeout(() => {
                if (sessionStorage.getItem(testKey) === 'test_value') {
                    console.log('PWA sessionStorage persistence confirmed');
                } else {
                    console.warn('PWA sessionStorage persistence may be compromised');
                }
                sessionStorage.removeItem(testKey);
            }, 1000);
        }
    }

    // Test app conflict scenarios
    function testAppConflictScenarios() {
        // Simulate another app clearing properties
        console.log('Testing app conflict scenario...');
        
        // Store current add-on state
        const currentAddons = shoplazzaStorage.getAllAddons();
        
        // Simulate property wipe
        fetch('/api/cart/update', {
            method: 'POST',
            headers: getShoplazzaHeaders(),
            body: JSON.stringify({ 
                updates: { 123456: 1 }, 
                properties: {} 
            })
        })
        .then(() => {
            console.log('App conflict simulation completed');
            
            // Verify recovery mechanism works
            setTimeout(() => {
                const recoveredAddons = shoplazzaStorage.getAllAddons();
                if (recoveredAddons.length > 0) {
                    console.log('App conflict recovery successful');
                } else {
                    console.warn('App conflict recovery may need improvement');
                }
            }, 2000);
        })
        .catch(error => {
            console.error('App conflict simulation failed:', error);
        });
    }

    // Utility function for price conversion (simplified)
    function convertPrice(price, currency) {
        // In production, implement proper currency conversion
        // For now, return the original price
        return price;
    }

    // Utility function to update displayed add-on prices
    function updateDisplayedAddonPrices(currency) {
        // Update any displayed add-on prices on the page
        const priceElements = document.querySelectorAll('.addon-price');
        priceElements.forEach(element => {
            // In production, implement proper currency display
            console.log(`Updated add-on price display for currency: ${currency}`);
        });
    }

    var ShoplazzaAddonWidget = {
        initialized: false,
        currentProductId: null,
        addOnConfig: null,
        addOnPreference: false,
        
        init: function() {
            if (this.initialized) return;
            this.initialized = true;
            
            // Clean expired storage entries
            shoplazzaStorage.clearExpired();
            
            // Setup all Phase 2 features
            this.setupPhase2Features();
            
            this.detectCurrentProduct();
            if (this.currentProductId) {
                this.loadAddOnConfig();
            }
            this.interceptProductForm();
        },

        setupPhase2Features: function() {
            // Setup Shoplazza event listeners
            this.setupShoplazzaEventListeners();
            
            // Setup cart modification protection
            setupCartModificationProtection();
            
            // Setup checkout guard
            setupCheckoutGuard();
            
            // Setup analytics and performance monitoring
            setupAnalyticsTracking();
            setupPerformanceMonitoring();
            
            // Test mobile PWA behavior
            testMobilePWABehavior();
            
            console.log('Phase 2 features initialized successfully');
        },

        setupShoplazzaEventListeners: function() {
            // Listen for Shoplazza cart updates and section unloads
            document.addEventListener('shoplazza:cart:updated', function(event) {
                console.log('Shoplazza cart updated, checking for lost properties...');
                window.__addonsRestored = 0; // Reset counter for analytics
                restoreLostAddOnProperties();
                
                // Track cart property persistence for analytics
                if (window.Shoplazza && window.Shoplazza.analytics) {
                    window.Shoplazza.analytics.track('Cart Properties Updated', {
                        count: shoplazzaStorage.getAllAddons().length,
                        restored: window.__addonsRestored || 0,
                        timestamp: Date.now()
                    });
                }
            });

            document.addEventListener('shoplazza:section:unload', function(event) {
                if (event.detail.sectionId === 'cart-drawer') {
                    console.log('Cart drawer closed, backing up current state...');
                    backupCurrentCartState();
                }
            });

            // Multi-currency support
            document.addEventListener('shoplazza:currency:changed', function(event) {
                console.log('Currency changed, updating add-on prices...');
                updateAddonPricesForCurrency(event.detail.currency || window.Shoplazza.currency.current);
            });

            console.log('Shoplazza event listeners setup complete');
        },
        
        detectCurrentProduct: function() {
            // Enhanced product detection for Shoplazza
            var variantInput = document.querySelector('form[action*="/cart/add"] input[name="id"]');
            if (variantInput && variantInput.value) {
                this.currentProductId = variantInput.value;
            }
            
            // Also try to detect from URL or other Shoplazza-specific selectors
            if (!this.currentProductId) {
                const productIdMatch = window.location.pathname.match(/\/products\/([^\/]+)/);
                if (productIdMatch) {
                    this.currentProductId = productIdMatch[1];
                }
            }
        },
        
        loadAddOnConfig: function() {
            // Load configuration via JSONP
            var callbackName = 'shoplazzaAddOnCallback_' + Date.now();
            window[callbackName] = function(config) {
                if (config.success && config.hasAddOn && config.addOn.isActive) {
                    ShoplazzaAddonWidget.addOnConfig = config.addOn;
                    ShoplazzaAddonWidget.renderWidget();
                }
            };
            
            var script = document.createElement('script');
            script.src = WIDGET_CONFIG.apiEndpoint + '/api/widget/config?shop=' + 
                        encodeURIComponent(WIDGET_CONFIG.shop) + 
                        '&productId=' + this.currentProductId + 
                        '&callback=' + callbackName;
            document.head.appendChild(script);
        },
        
        renderWidget: function() {
            // Widget is already rendered by HTML template
            this.restorePreference();
            this.addEventListeners();
        },
        
        restorePreference: function() {
            // Try to restore from sessionStorage first (Phase 2)
            var backup = shoplazzaStorage.getAddon(this.currentProductId);
            if (backup && backup.addOnConfig) {
                this.addOnConfig = backup.addOnConfig;
                this.addOnPreference = true;
                console.log('Restored add-on preference from sessionStorage');
            } else {
                // Fallback to localStorage (Phase 1)
                var savedPreference = localStorage.getItem('shoplazza_addon_preference_' + this.currentProductId);
                if (savedPreference === 'true') {
                    this.addOnPreference = true;
                }
            }
            
            // Update UI
            var checkbox = document.querySelector('.addon-checkbox');
            if (checkbox) {
                checkbox.checked = this.addOnPreference;
            }
        },
        
        addEventListeners: function() {
            var checkbox = document.querySelector('.addon-checkbox');
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    ShoplazzaAddonWidget.handleAddOnToggle(this.checked);
                });
            }
        },
        
        handleAddOnToggle: function(isChecked) {
            this.addOnPreference = isChecked;
            
            // Store in both localStorage (backward compatibility) and sessionStorage (Phase 2)
            localStorage.setItem('shoplazza_addon_preference_' + this.currentProductId, isChecked);
            
            if (isChecked && this.addOnConfig) {
                // Backup to sessionStorage with Phase 2 naming
                backupAddOnSelections(this.currentProductId, this.addOnConfig);
                this.showAddOnConfirmation();
            }
        },
        
        interceptProductForm: function() {
            var self = this;
            var forms = document.querySelectorAll('form[action*="/cart/add"]');
            
            forms.forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    if (self.addOnPreference && self.addOnConfig) {
                        // Set properties for add-on selection with Shoplazza naming (Phase 2)
                        var addonTypeInput = document.createElement('input');
                        addonTypeInput.type = 'hidden';
                        addonTypeInput.name = 'properties[_add_on_type]';
                        addonTypeInput.value = 'protection_plan';
                        form.appendChild(addonTypeInput);
                        
                        var addonNameInput = document.createElement('input');
                        addonNameInput.type = 'hidden';
                        addonNameInput.name = 'properties[_add_on_name]';
                        addonNameInput.value = self.addOnConfig.title;
                        form.appendChild(addonNameInput);
                        
                        var addonPriceInput = document.createElement('input');
                        addonPriceInput.type = 'hidden';
                        addonPriceInput.name = 'properties[_add_on_price]';
                        addonPriceInput.value = self.addOnConfig.price.toString();
                        form.appendChild(addonPriceInput);
                        
                        var addonSkuInput = document.createElement('input');
                        addonSkuInput.type = 'hidden';
                        addonSkuInput.name = 'properties[_add_on_sku]';
                        addonSkuInput.value = self.addOnConfig.sku;
                        form.appendChild(addonSkuInput);
                        
                        var addonDescriptionInput = document.createElement('input');
                        addonDescriptionInput.type = 'hidden';
                        addonDescriptionInput.name = 'properties[_add_on_description]';
                        addonDescriptionInput.value = self.addOnConfig.description || '';
                        form.appendChild(addonDescriptionInput);
                        
                        var compressedFlagInput = document.createElement('input');
                        compressedFlagInput.type = 'hidden';
                        compressedFlagInput.name = 'properties[_compressed]';
                        compressedFlagInput.value = 'true';
                        form.appendChild(compressedFlagInput);
                        
                        // Also add compressed data for complex configurations
                        var compressedDataInput = document.createElement('input');
                        compressedDataInput.type = 'hidden';
                        compressedDataInput.name = 'properties[_add_on_data]';
                        compressedDataInput.value = btoa(JSON.stringify({
                            title: self.addOnConfig.title,
                            price: self.addOnConfig.price,
                            sku: self.addOnConfig.sku,
                            description: self.addOnConfig.description || '',
                            variantId: self.addOnConfig.variantId
                        }));
                        form.appendChild(compressedDataInput);
                        
                        // Backup add-on selection to sessionStorage
                        backupAddOnSelections(self.currentProductId, self.addOnConfig);
                        
                        console.log('Form intercepted and Shoplazza add-on properties added with Phase 2 backup');
                    }
                });
            });
        },
        
        showAddOnConfirmation: function() {
            if (!this.addOnConfig) return;
            
            var message = 'Add-on selected: ' + this.addOnConfig.title + 
                         ' (+$' + this.addOnConfig.price + ')';
            alert(message);
        }
    };
    
    // Initialize widget
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            ShoplazzaAddonWidget.init();
        });
    } else {
        ShoplazzaAddonWidget.init();
    }
    
    // Make available globally for debugging
    window.ShoplazzaAddonWidget = ShoplazzaAddonWidget;
    window.shoplazzaStorage = shoplazzaStorage; // Expose for debugging
})();
