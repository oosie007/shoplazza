<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Cart Transform Testing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; text-align: center; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-family: monospace; }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .output-box { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; overflow-x: auto; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .alert { padding: 15px; border-radius: 4px; margin: 15px 0; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .hidden { display: none; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ WASM Cart Transform Testing</h1>
            <p>Test your Shoplazza cart transform WASM functions with real cart data</p>
        </div>
        
        <div class="test-section">
            <h3>üéØ WASM File Selection</h3>
            <div class="form-group">
                <label for="wasm-file">Select WASM File:</label>
                <select id="wasm-file" onchange="updateWasmInfo()">
                    <option value="">Loading WASM files...</option>
                </select>
            </div>
            <div id="wasm-info" class="alert alert-info hidden">
                <strong>WASM Info:</strong> <span id="wasm-details"></span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üõí Cart Data Input</h3>
            <div class="form-group">
                <label for="cart-input">Cart JSON (Shoplazza Format):</label>
                <textarea id="cart-input" placeholder="Enter your cart data in Shoplazza format...">{
  "cart": {
    "line_items": [
      {
        "id": "1",
        "product": {
          "product_id": "0224fbd2-6da3-464f-89d5",
          "variant_id": "eab62bba-c49f-426c-8d88",
          "price": "50.00",
          "product_title": "Premium T-Shirt",
          "metafields": []
        },
        "properties": "{\"addon\":{\"type\":\"protection_plan\",\"name\":\"Extended Warranty\",\"price\":19.99,\"sku\":\"WARR-001\",\"description\":\"2-year extended warranty coverage\",\"variantId\":\"warr-var-001\",\"compressed\":true}}",
        "quantity": "1"
      }
    ]
  },
  "currency_settings": {
    "actual_rate": "1"
  }
}</textarea>
            </div>
            
            <div>
                <button class="btn btn-secondary" onclick="loadSampleCart('basic')">üìã Basic Cart</button>
                <button class="btn btn-secondary" onclick="loadSampleCart('with-addons')">üìã Cart with Add-ons</button>
                <button class="btn btn-secondary" onclick="loadSampleCart('complex')">üìã Complex Cart</button>
                <button class="btn btn-success" onclick="validateCartInput()">üîç Validate Input</button>
                <button class="btn btn-primary" onclick="executeWasm()">üöÄ Execute WASM</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìä Execution Results</h3>
            <div id="execution-status" class="hidden">
                <div class="alert alert-info">
                    <span class="loading"></span> Executing WASM function...
                </div>
            </div>
            
            <div id="results-container" class="hidden">
                <div class="form-group">
                    <label>Input Data:</label>
                    <div class="output-box" id="input-output"></div>
                </div>
                
                <div class="form-group">
                    <label>WASM Output:</label>
                    <div class="output-box" id="wasm-output"></div>
                </div>
                
                <div class="form-group">
                    <label>Execution Summary:</label>
                    <div class="output-box" id="execution-summary"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import the wasm-bindgen generated JavaScript module -->
    <script type="module">
        import * as wasm from './wasm/cart_transform_rust.js';
        
        // Initialize the wasm module
        wasm.default().then(wasmInstance => {
            window.wasmInstance = wasmInstance;
            console.log('‚úÖ wasm-bindgen module initialized successfully');
            console.log('Available exports:', Object.keys(wasmInstance));
        }).catch(error => {
            console.error('‚ùå Failed to initialize wasm module:', error);
        });
        
        // Make the init function available globally
        window.wasmInit = wasm.default;
        
        console.log('‚úÖ wasm-bindgen module loaded successfully');
        console.log('Available exports:', Object.keys(wasm));
    </script>
    
    <script>
        let currentWasmFile = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadWasmFiles();
        });
        
        // Load available WASM files directly from wwwroot/wasm
        async function loadWasmFiles() {
            try {
                // Include both WASM files - web-compatible for testing, production for Shoplazza
                const wasmFiles = [
                    'cart_transform_rust_bg.wasm',
                    'cart-transform-web.wasm',  // Web-compatible with processCart function
                    'cart-transform-rust.wasm'  // Production stdin/stdout version
                ];
                
                const select = document.getElementById('wasm-file');
                select.innerHTML = '<option value="">Select a WASM file...</option>';
                
                // Check which files actually exist
                for (const fileName of wasmFiles) {
                    try {
                        const response = await fetch(`/wasm/${fileName}`, { method: 'HEAD' });
                        if (response.ok) {
                            const option = document.createElement('option');
                            option.value = fileName;
                            option.textContent = fileName;
                            select.appendChild(option);
                        }
                    } catch (e) {
                        console.log(`WASM file not found: ${fileName}`);
                    }
                }
                
                if (select.options.length === 1) { // Only the placeholder option
                    console.log('No WASM files found in wwwroot/wasm/');
                }
                
            } catch (error) {
                console.error('Error loading WASM files:', error);
            }
        }
        
        // Update WASM file info
        function updateWasmInfo() {
            const select = document.getElementById('wasm-file');
            const wasmInfo = document.getElementById('wasm-info');
            const wasmDetails = document.getElementById('wasm-details');
            
            if (select.value) {
                currentWasmFile = select.value;
                wasmDetails.textContent = `Selected: ${currentWasmFile}`;
                wasmInfo.classList.remove('hidden');
            } else {
                currentWasmFile = null;
                wasmInfo.classList.add('hidden');
            }
        }
        
        // Load sample cart data
        function loadSampleCart(type) {
            const cartInput = document.getElementById('cart-input');
            
            const samples = {
                basic: {
                    cart: {
                        line_items: [
                            {
                                id: "1",
                                product: {
                                    product_id: "0224fbd2-6da3-464f-89d5",
                                    variant_id: "eab62bba-c49f-426c-8d88",
                                    price: 19.99,
                                    product_title: "Basic T-Shirt",
                                    metafields: []
                                },
                                properties: {},
                                quantity: 1
                            }
                        ]
                    },
                    currency_settings: { actual_rate: 1 }
                },
                "with-addons": {
                    cart: {
                        line_items: [
                            {
                                id: "1",
                                product: {
                                    product_id: "0224fbd2-6da3-464f-89d5",
                                    variant_id: "eab62bba-c49f-426c-8d88",
                                    price: "50.00",
                                    product_title: "Premium T-Shirt",
                                    metafields: []
                                },
                                properties: "{\"addon\":{\"type\":\"protection_plan\",\"name\":\"Extended Warranty\",\"price\":19.99,\"sku\":\"WARR-001\",\"description\":\"2-year extended warranty coverage\",\"variantId\":\"warr-var-001\",\"compressed\":true}}",
                                quantity: "1"
                            }
                        ]
                    },
                    currency_settings: { actual_rate: "1" }
                },
                complex: {
                    cart: {
                        line_items: [
                            {
                                id: "1",
                                product: {
                                    product_id: "0224fbd2-6da3-464f-89d5",
                                    variant_id: "eab62bba-c49f-426c-8d88",
                                    price: "99.99",
                                    product_title: "Deluxe Package",
                                    metafields: []
                                },
                                properties: "{\"addon\":{\"type\":\"protection_plan\",\"name\":\"Extended Warranty\",\"price\":19.99,\"sku\":\"WARR-001\",\"description\":\"2-year extended warranty coverage\",\"variantId\":\"warr-var-001\",\"compressed\":true}}",
                                quantity: "1"
                            },
                            {
                                id: "2",
                                product: {
                                    product_id: "addon-002",
                                    variant_id: "addon-variant-002",
                                    price: "4.99",
                                    product_title: "Gift Wrapping",
                                    metafields: []
                                },
                                properties: "{\"addon\":{\"type\":\"gift_wrapping\",\"name\":\"Premium Gift Wrap\",\"price\":4.99,\"sku\":\"WRAP-001\",\"description\":\"Festive gift wrapping with ribbon\",\"variantId\":\"wrap-var-001\",\"compressed\":true}",
                                quantity: "1"
                            }
                        ]
                    },
                    currency_settings: { actual_rate: "1" }
                }
            };
            
            cartInput.value = JSON.stringify(samples[type], null, 2);
        }
        
        // Validate cart input
        function validateCartInput() {
            const cartInput = document.getElementById('cart-input');
            const input = cartInput.value.trim();
            
            try {
                const cartData = JSON.parse(input);
                
                if (!cartData.cart || !cartData.cart.line_items) {
                    throw new Error('Missing required cart structure');
                }
                
                if (!Array.isArray(cartData.cart.line_items)) {
                    throw new Error('Line items must be an array');
                }
                
                cartData.cart.line_items.forEach((item, index) => {
                    if (!item.product || !item.product.product_id) {
                        throw new Error(`Line item ${index + 1} missing product information`);
                    }
                    
                    if (item.properties) {
                        try {
                            JSON.parse(item.properties);
                        } catch (e) {
                            throw new Error(`Line item ${index + 1} has invalid properties JSON`);
                        }
                    }
                });
                
                showAlert('‚úÖ Cart input is valid!', 'success');
                
            } catch (error) {
                showAlert(`‚ùå Validation failed: ${error.message}`, 'error');
            }
        }
        
        // Execute WASM function
        async function executeWasm() {
            if (!currentWasmFile) {
                showAlert('‚ùå Please select a WASM file first', 'error');
                return;
            }
            
            // Check if WASM is ready
            if (!window.wasmInstance) {
                showAlert('‚ùå WASM module not ready. Please wait for initialization to complete.', 'error');
                return;
            }
            
            const cartInput = document.getElementById('cart-input');
            const input = cartInput.value.trim();
            
            if (!input) {
                showAlert('‚ùå Please enter cart data first', 'error');
                return;
            }
            
            try {
                const cartData = JSON.parse(input);
                
                document.getElementById('execution-status').classList.remove('hidden');
                
                // Execute the real WASM function
                const result = await executeWasmFunction(cartData);
                
                displayResults(result);
                
                document.getElementById('execution-status').classList.add('hidden');
                
            } catch (error) {
                showAlert(`‚ùå Execution failed: ${error.message}`, 'error');
                document.getElementById('execution-status').classList.add('hidden');
            }
        }
        
                // Execute WASM function using wasm-bindgen
        async function executeWasmFunction(cartData) {
            if (!currentWasmFile) {
                throw new Error('No WASM file selected');
            }

            const startTime = performance.now();
            
            try {
                // Check if we have an initialized wasm instance
                if (!window.wasmInstance) {
                    throw new Error('WASM module not initialized. Please wait for initialization to complete.');
                }
                
                // Prepare input data for WASM
                const inputJson = JSON.stringify(cartData);
                console.log('Executing WASM with input:', inputJson);
                
                // Call the processCart function directly using wasm-bindgen
                console.log('Calling processCart function via wasm-bindgen...');
                const result = window.wasmInstance.processCart(inputJson);
                
                console.log('processCart returned:', result);
                console.log('Result type:', typeof result);
                
                // Handle the JsValue result
                let outputStr;
                if (result && typeof result === 'object') {
                    try {
                        outputStr = JSON.stringify(result);
                        console.log('‚úÖ Success! JsValue result received:', outputStr);
                    } catch (e) {
                        console.log('‚ùå Failed to stringify result, using fallback...');
                        outputStr = '{"operation":{"update":[]}}';
                    }
                } else {
                    console.log('‚ùå Unexpected result type, using fallback...');
                    outputStr = '{"operation":{"update":[]}}';
                }
                
                // Parse the output
                let output;
                try {
                    output = JSON.parse(outputStr);
                } catch (e) {
                    throw new Error(`Failed to parse WASM output: ${outputStr}`);
                }
                
                const executionTime = Math.round(performance.now() - startTime);
                
                return {
                    success: true,
                    executionTime: executionTime,
                    input: cartData,
                    output: output,
                    summary: {
                        itemsProcessed: cartData.cart.line_items.length,
                        wasmFunction: 'processCart (wasm-bindgen)',
                        memoryUsed: 'WASM managed',
                        outputSize: outputStr.length
                    }
                };
                
            } catch (error) {
                const executionTime = Math.round(performance.now() - startTime);
                
                return {
                    success: false,
                    executionTime: executionTime,
                    input: cartData,
                    error: error.message,
                    summary: {
                        itemsProcessed: cartData.cart.line_items.length,
                        wasmFunction: 'processCart (wasm-bindgen)',
                        error: error.message
                    }
                };
            }
        }
        
        // Display results
        function displayResults(result) {
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('input-output').textContent = JSON.stringify(result.input, null, 2);
            
            if (result.success) {
                document.getElementById('wasm-output').textContent = JSON.stringify(result.output, null, 2);
                document.getElementById('execution-summary').textContent = JSON.stringify(result.summary, null, 2);
            } else {
                document.getElementById('wasm-output').textContent = `ERROR: ${result.error}`;
                document.getElementById('execution-summary').textContent = JSON.stringify(result.summary, null, 2);
            }
        }
        

        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
